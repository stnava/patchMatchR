<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>deepPatchMatch patch match two images with deep features — deepPatchMatch • patchMatchR</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="deepPatchMatch patch match two images with deep features — deepPatchMatch" />
<meta property="og:description" content="High-level function for deep patch matching that makes many assumptions and
therefore minimizes the number of parameters the user needs to choose." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patchMatchR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/patchMatchR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>deepPatchMatch patch match two images with deep features</h1>
    
    <div class="hidden name"><code>deepPatchMatch.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>High-level function for deep patch matching that makes many assumptions and
therefore minimizes the number of parameters the user needs to choose.</p>
    </div>

    <pre class="usage"><span class='fu'>deepPatchMatch</span><span class='op'>(</span>
  <span class='va'>movingImage</span>,
  <span class='va'>fixedImage</span>,
  <span class='va'>movingImageMask</span>,
  <span class='va'>fixedImageMask</span>,
  movingPatchSize <span class='op'>=</span> <span class='fl'>32</span>,
  fixedPatchSize <span class='op'>=</span> <span class='fl'>32</span>,
  knn <span class='op'>=</span> <span class='fl'>1</span>,
  knnSpatial <span class='op'>=</span> <span class='fl'>0</span>,
  <span class='va'>featureSubset</span>,
  block_name <span class='op'>=</span> <span class='st'>"block2_conv2"</span>,
  switchMatchDirection <span class='op'>=</span> <span class='cn'>FALSE</span>,
  kPackage <span class='op'>=</span> <span class='st'>"RcppHNSW"</span>,
  <span class='va'>vggmodel</span>,
  subtractor <span class='op'>=</span> <span class='fl'>127.5</span>,
  patchVarEx <span class='op'>=</span> <span class='fl'>0.95</span>,
  meanCenter <span class='op'>=</span> <span class='cn'>FALSE</span>,
  <span class='va'>initialMovingTransform</span>,
  verbose <span class='op'>=</span> <span class='cn'>FALSE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>movingImage</th>
      <td><p>input image from which we extract patches that are
transformed to the space of the fixed image</p></td>
    </tr>
    <tr>
      <th>fixedImage</th>
      <td><p>input image that provides the fixed reference domain.</p></td>
    </tr>
    <tr>
      <th>movingImageMask</th>
      <td><p>defines the object of interest in the movingImage</p></td>
    </tr>
    <tr>
      <th>fixedImageMask</th>
      <td><p>defines the object of interest in the fixedImage</p></td>
    </tr>
    <tr>
      <th>movingPatchSize</th>
      <td><p>integer greater than or equal to 32.</p></td>
    </tr>
    <tr>
      <th>fixedPatchSize</th>
      <td><p>integer greater than or equal to 32.</p></td>
    </tr>
    <tr>
      <th>knn</th>
      <td><p>k-nearest neighbors ( should be &gt;= 1  )</p></td>
    </tr>
    <tr>
      <th>knnSpatial</th>
      <td><p>k-nearest neighbors for spatial localization (optional).
this will constrain the search to more proximal locations.  will perform
better if the images are in the same physical space. currently, the units
for the spatial distance is in voxels.  may add physical space option later.
FIXME - allow a transformation to be passed to this step s.t. moving points
can be transformed to fixed space before distance assessment.</p></td>
    </tr>
    <tr>
      <th>featureSubset</th>
      <td><p>a vector that selects a subset of features</p></td>
    </tr>
    <tr>
      <th>block_name</th>
      <td><p>name of vgg feature block, either block2_conv2 or integer.
use the former for smaller patch sizes.</p></td>
    </tr>
    <tr>
      <th>switchMatchDirection</th>
      <td><p>boolean</p></td>
    </tr>
    <tr>
      <th>kPackage</th>
      <td><p>name of package to use for knn</p></td>
    </tr>
    <tr>
      <th>vggmodel</th>
      <td><p>prebuilt feature model</p></td>
    </tr>
    <tr>
      <th>subtractor</th>
      <td><p>value to subtract when scaling image intensity; should be
chosen to match training paradigm eg 127.5 for vgg and 0.5 for resnet like.</p></td>
    </tr>
    <tr>
      <th>patchVarEx</th>
      <td><p>patch variance explained for ripmmarc</p></td>
    </tr>
    <tr>
      <th>meanCenter</th>
      <td><p>boolean to mean center each patch for ripmmarc</p></td>
    </tr>
    <tr>
      <th>initialMovingTransform</th>
      <td><p>optional initial transformation to moving image</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p>boolean</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>correspondence data</p>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Avants BB</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span> <span class='va'><a href='https://keras.rstudio.com'>keras</a></span> <span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span> <span class='va'>ANTsR</span> <span class='op'>)</span>
<span class='va'>nP1</span> <span class='op'>=</span> <span class='fl'>5</span>
<span class='va'>nP2</span> <span class='op'>=</span> <span class='fl'>20</span>
<span class='va'>psz</span> <span class='op'>=</span> <span class='fl'>32</span>
<span class='va'>img</span> <span class='op'>&lt;-</span> <span class='fu'>ri</span><span class='op'>(</span> <span class='fl'>1</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>iMath</span><span class='op'>(</span> <span class='st'>"Normalize"</span> <span class='op'>)</span>
<span class='va'>img2</span> <span class='op'>&lt;-</span> <span class='fu'>ri</span><span class='op'>(</span> <span class='fl'>2</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>iMath</span><span class='op'>(</span> <span class='st'>"Normalize"</span> <span class='op'>)</span>
<span class='va'>mask</span> <span class='op'>=</span> <span class='fu'>randomMask</span><span class='op'>(</span> <span class='fu'>getMask</span><span class='op'>(</span> <span class='va'>img</span> <span class='op'>)</span>, <span class='va'>nP1</span> <span class='op'>)</span>
<span class='va'>mask2</span> <span class='op'>=</span> <span class='fu'>randomMask</span><span class='op'>(</span> <span class='fu'>getMask</span><span class='op'>(</span> <span class='va'>img2</span> <span class='op'>)</span>, <span class='va'>nP2</span> <span class='op'>)</span>
<span class='va'>match</span> <span class='op'>=</span> <span class='fu'>deepPatchMatch</span><span class='op'>(</span> <span class='va'>img2</span>, <span class='va'>img</span>, <span class='va'>mask</span>, <span class='va'>mask2</span> <span class='op'>)</span>
<span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span> <span class='va'>ANTsR</span> <span class='op'>)</span>
<span class='va'>img</span> <span class='op'>&lt;-</span> <span class='fu'>ri</span><span class='op'>(</span> <span class='fl'>1</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>iMath</span><span class='op'>(</span> <span class='st'>"Normalize"</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>resampleImage</span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span> <span class='fl'>2</span>, <span class='fl'>2</span> <span class='op'>)</span> <span class='op'>)</span>
<span class='va'>nP1</span> <span class='op'>=</span> <span class='fl'>10</span>
<span class='va'>nP2</span> <span class='op'>=</span> <span class='fl'>40</span>
<span class='va'>psz</span> <span class='op'>=</span> <span class='fl'>32</span>
<span class='va'>mask</span> <span class='op'>=</span> <span class='fu'>randomMask</span><span class='op'>(</span> <span class='fu'>getMask</span><span class='op'>(</span> <span class='va'>img</span> <span class='op'>)</span>, <span class='va'>nP1</span> <span class='op'>)</span>
<span class='va'>features</span> <span class='op'>=</span> <span class='fu'><a href='deepFeatures.html'>deepFeatures</a></span><span class='op'>(</span> <span class='va'>img</span>, <span class='va'>mask</span>, patchSize <span class='op'>=</span> <span class='va'>psz</span> <span class='op'>)</span>
<span class='va'>img2</span> <span class='op'>&lt;-</span> <span class='fu'>ri</span><span class='op'>(</span> <span class='fl'>5</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>iMath</span><span class='op'>(</span> <span class='st'>"Normalize"</span> <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>resampleImage</span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span> <span class='fl'>2</span>, <span class='fl'>2</span> <span class='op'>)</span> <span class='op'>)</span>
<span class='va'>txStretch</span> <span class='op'>=</span> <span class='fu'>createAntsrTransform</span><span class='op'>(</span> <span class='st'>"AffineTransform"</span>, dim<span class='op'>=</span><span class='fl'>2</span> <span class='op'>)</span>
<span class='va'>params</span> <span class='op'>=</span> <span class='fu'>getAntsrTransformParameters</span><span class='op'>(</span> <span class='va'>txStretch</span> <span class='op'>)</span>
<span class='va'>params</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>=</span> <span class='fl'>0.8</span>
<span class='fu'>setAntsrTransformParameters</span><span class='op'>(</span><span class='va'>txStretch</span>, <span class='va'>params</span><span class='op'>)</span>
<span class='va'>cos45</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Trig.html'>cos</a></span><span class='op'>(</span><span class='va'>pi</span><span class='op'>*</span><span class='fl'>45</span><span class='op'>/</span><span class='fl'>180</span><span class='op'>)</span>
<span class='va'>sin45</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Trig.html'>sin</a></span><span class='op'>(</span><span class='va'>pi</span><span class='op'>*</span><span class='fl'>45</span><span class='op'>/</span><span class='fl'>180</span><span class='op'>)</span>
<span class='va'>txRotate</span> <span class='op'>&lt;-</span> <span class='fu'>createAntsrTransform</span><span class='op'>(</span> precision<span class='op'>=</span><span class='st'>"float"</span>, type<span class='op'>=</span><span class='st'>"AffineTransform"</span>, dim<span class='op'>=</span><span class='fl'>2</span> <span class='op'>)</span>
<span class='fu'>setAntsrTransformParameters</span><span class='op'>(</span><span class='va'>txRotate</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>cos45</span>,<span class='op'>-</span><span class='va'>sin45</span>,<span class='va'>sin45</span>,<span class='va'>cos45</span>,<span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span> <span class='op'>)</span>
<span class='fu'>setAntsrTransformFixedParameters</span><span class='op'>(</span><span class='va'>txRotate</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>128</span>,<span class='fl'>128</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>rotateFirst</span> <span class='op'>=</span> <span class='fu'>composeAntsrTransforms</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>txStretch</span>, <span class='va'>txRotate</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'># img2 = applyAntsrTransform(rotateFirst, img2, img2)</span>
<span class='va'>mask2</span> <span class='op'>=</span> <span class='fu'>randomMask</span><span class='op'>(</span> <span class='fu'>getMask</span><span class='op'>(</span> <span class='va'>img2</span> <span class='op'>)</span>, <span class='va'>nP2</span> <span class='op'>)</span>
<span class='va'>match</span> <span class='op'>=</span> <span class='fu'>deepPatchMatch</span><span class='op'>(</span> <span class='va'>img2</span>, <span class='va'>img</span>, <span class='va'>mask2</span>, <span class='va'>mask</span>, <span class='fl'>64</span>, <span class='fl'>64</span> <span class='op'>)</span>

<span class='kw'>for</span> <span class='op'>(</span> <span class='va'>k</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>matches</span> <span class='op'>)</span> <span class='op'>)</span> <span class='op'>{</span>
  <span class='kw'>if</span> <span class='op'>(</span> <span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>matches</span><span class='op'>[</span><span class='va'>k</span>,<span class='fl'>1</span><span class='op'>]</span> <span class='op'>)</span> <span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/graphics/layout.html'>layout</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span>,nrow<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span> <span class='fu'>as.antsImage</span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>ffeatures</span><span class='op'>$</span><span class='va'>patches</span><span class='op'>[</span><span class='va'>k</span>,,<span class='op'>]</span> <span class='op'>)</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span> <span class='fu'>as.antsImage</span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>mfeatures</span><span class='op'>$</span><span class='va'>patches</span><span class='op'>[</span><span class='va'>match</span><span class='op'>$</span><span class='va'>matches</span><span class='op'>[</span><span class='va'>k</span>,<span class='fl'>1</span><span class='op'>]</span>,,<span class='op'>]</span> <span class='op'>)</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='va'>k</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>ffeatures</span><span class='op'>$</span><span class='va'>patchCoords</span><span class='op'>[</span><span class='va'>k</span>,<span class='op'>]</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='va'>match</span><span class='op'>$</span><span class='va'>mfeatures</span><span class='op'>$</span><span class='va'>patchCoords</span><span class='op'>[</span><span class='va'>match</span><span class='op'>$</span><span class='va'>matches</span><span class='op'>[</span><span class='va'>k</span>,<span class='fl'>1</span><span class='op'>]</span>,<span class='op'>]</span> <span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/Sys.sleep.html'>Sys.sleep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>
    <span class='op'>}</span>
<span class='op'>}</span>
<span class='op'>}</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Brian B. Avants.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


